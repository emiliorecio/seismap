CREATE TABLE agency
(
  id BIGINT NOT NULL,
  code CHARACTER VARYING(3) NOT NULL,
  CONSTRAINT agency_pkey PRIMARY KEY (id),
  CONSTRAINT agency_code_key UNIQUE (code)
)
WITH (
  OIDS=FALSE
);
ALTER TABLE agency OWNER TO postgres;


CREATE TABLE event
(
  id BIGINT NOT NULL,
  date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
  depth NUMERIC(4,1) NOT NULL,
  CONSTRAINT event_pkey PRIMARY KEY (id)
)
WITH (
  OIDS=TRUE
);
ALTER TABLE event OWNER TO postgres;

CREATE INDEX event_oid ON event (oid);

SELECT AddGeometryColumn('event', 'location', 900913, 'POINT', 2);

CREATE TABLE magnitude
(
  id BIGINT NOT NULL,
  "type" CHARACTER VARYING(8) NOT NULL,
  "value" NUMERIC(3,1) NOT NULL,
  reportingagency_id BIGINT NOT NULL,
  event_id BIGINT NOT NULL,
  CONSTRAINT magnitude_pkey PRIMARY KEY (id),
  CONSTRAINT fk_event_id FOREIGN KEY (event_id)
      REFERENCES event (id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT fk_reportingagency_id FOREIGN KEY (reportingagency_id)
      REFERENCES agency (id) MATCH SIMPLE
      ON UPDATE NO ACTION ON DELETE NO ACTION
)
WITH (
  OIDS=FALSE
);
ALTER TABLE magnitude OWNER TO postgres;

CREATE VIEW eventandml (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND magnitude.type = 'ML')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        

CREATE VIEW eventandmb (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND magnitude.type = 'MB')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        
CREATE VIEW eventandms (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND magnitude.type = 'MS')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        
CREATE VIEW eventandmw (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND magnitude.type = 'MW')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        
CREATE VIEW eventandmblg (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND  magnitude.type = 'MBLG')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        
CREATE VIEW eventandmc (id, date, depth, location, magnitudeValue) AS (
    SELECT
        event.id AS id,
        event.date as date,
        event.depth as depth,
        event.location as location,
        AVG(magnitude.value) as magnitudeValue
    FROM
        event
        LEFT OUTER JOIN magnitude ON (event.id = magnitude.event_id AND magnitude.type = 'MC')
    GROUP BY
        event.id,
        event.date,
        event.depth,
        event.location);
        